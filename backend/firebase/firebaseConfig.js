const admin = require('firebase-admin');
const { getFirestore, FieldValue } = require('firebase-admin/firestore');
const { getStorage } = require('firebase-admin/storage');

const serviceAccountBase64 = "ew0KICAidHlwZSI6ICJzZXJ2aWNlX2FjY291bnQiLA0KICAicHJvamVjdF9pZCI6ICJ3b3JsZHdpc2UtZTIzOTkiLA0KICAicHJpdmF0ZV9rZXlfaWQiOiAiNmRlM2IzOWZmYTVhMWY2NDk0NWViNTFiODUxY2UyOTI4ZTJjMmE1YiIsDQogICJwcml2YXRlX2tleSI6ICItLS0tLUJFR0lOIFBSSVZBVEUgS0VZLS0tLS1cbk1JSUV2UUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktjd2dnU2pBZ0VBQW9JQkFRQysyRU83MkRycm5mQ1lcbmhMTHVud1NkN0tpRW04WHAxSjg1N2NIT3p4YnVPbktzMXhzaTN3UjJnaW5SeFZHL2pva2tjMngxVmp6YU1DbVlcbkxyNTFvWGhiZlBiWkcybDlEN3JPQ2N0ak9HN2I1U2lZdVRiQlcxSmlmREdsck9MZVE3REpJMVRjTCs4SkxKZEJcbkxCNlR5NmNvM1ZNVE8rejVYNytmQm1GZUorb2tOYXNFNzdnRVpVV1NBMllrQ3QzNXkzVHZTWDQyemFleXdybDlcbnhCcTNQdFpyOS9hdzRMbjE4Zmo5RkhKZjRpK2lKUW1abnRUN2kwVVRUc0Q1L2UydXBaTEFnTTUvbnB6ay9sY1ZcbkFoOU0yODJzdDNMQkNSQkRZRkFvZ1E1ZjFkdlhrRm8xZUtOUXd0QlM5TWRlQ2RjcHY5THh1YjRtMGFrNWorVjdcblF3dUVEWXJKQWdNQkFBRUNnZ0VBQmgxUU9EL0NqWU9ETHFQTHh0VHQ5VEJjcXRrQjA0N1dKaWs5dFNaUjdnS05cbjQ0ZEZ6WTEzSzJQYXVxZVhpYXRqcmZrTHY4dXFTZlJTbE5ka2owakQzaXlJRFNjeGIwb1dlbHo2ZVB5WklxNzZcbktNQ0FabHdLYlBEZE4xbHRjR0ViVkNwdllObWhUem93UTJ5S00wS0tZY2NManhsenEzNjdtVGovWENDcndncXVcbjcrTmxQcGNvQTRzdHB1SGwyWTZPdUZxVkxEUS9ZL1hFdi8xb1ZpemNHQVdwN0Ivbi9TR01VVXJYNnBCYzNHY1RcblU2UWtjTW1yR1dpdDNTNFRNV0hIREdrTjM3QzZzazRZalFzSytYMjd4Rk56MXUzdGVZUitUdEhONitnQjF6eEpcbml0QWozRStWYnZlTGhmTTRkeFZZV3ljT2RLenJnbUpTVmRoTEsyR3ZBUUtCZ1FEd2pTUG0wMld4cGZKZWl2QWpcbnkrTC94VnpqbytONmVTaVFaWUV1Wjg3R1ZnajhNd3dhbVk3UjNERU84ZXNGVGFqZ09Wcmo2NnZtTmZ6eDY4YldcbkJaRTd1ZGcvUTRDNEV5Y09QL005UVlheHVIQ1JFbURzemV0T0J4UUMwSStOaUM5bkpKd2hzSTBueWQ0dUhIeXlcbmc1UVJhS3R1ZnVSZmwyd2VkelhPVUEwTWdRS0JnUURMR2VpRFVUSjNaaXo4ZnZvbGdSbElkZTg0eWthY1JLV2dcbk5YanNpMGF6QzVISEtLa05ra1ZwS3M0V2lrN2xPdnNzYlphK3p5NWJpR1k2UFYvN09tRmU5VlZZYnNyS0JoUUVcbmtpeUpwZzJhUVYwei9mNWdxMElCb3AzQXhGbER3OU9VcUZxenZabFQrbklDUW5kcjM3V2ZwR0JoVGxUVjVSZ1RcbnJzaXdMcC82U1FLQmdRRGYxK2Ixci9mczFPaHg4OFk4K1VoMkMvbEJWOHVodDBiNC80dXpYQ1A5U2lnNFQyUlBcbkNGL3ZoNEFiVVNFTElWWXB1UldNREUwOC96WXZCT0ZWWFg3bFhpNE55TW5xQU9DU0VRNVBEVC9DOTBmQXA2S01cbkdaNkNVSEhkb0toRTR0cUJsMzYybHV6emZwVUN3YjJEL0k3M21EZ1dyWHZrUENyL09wMVdMQVhJZ1FLQmdBN1RcblpWV3dwNjV2bHZrWGk4c1JFWGRvcEgzUXhqYkNEQlVWMGkzeVBNYjFJVDhZaUw2azNzdytnNnpCaStEUDNXWHdcbjJnQXp2MzZQQm1kWjg1ZXpPMGhqUUVla1RzbFFpRVdOSmhNbU8vZjJyWWNPRTNPYkRNWnh5SEk1NHdvL1VVS1lcbng0WTNZT253YmtJYjkvdTM2Tm91ZFpxa3pTeVAvS0h6TUZNc0ZDR0JBb0dBR1RrVjhPRC9Yc2VmTEl4eGNIbEdcbmRNeTBVdVc2WWM5QkdnZ0dxUDhYaEprMDhCUlVDejdMNEhWUzgvLzJZeC9IUC9RdnA1RG4vNDJqeEw1Zm41N05cbkdsbmpHaVVyN1RkK1I2WFIxQUFvWU5IWHdjNTJNdXZ3M0lublpWZ01Bb25zcnRodWpyRHMrV0NQbTBOa0tKbUFcbjBzR1lpcTJ5TThra2dRWVZ5bitDZmFNPVxuLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLVxuIiwNCiAgImNsaWVudF9lbWFpbCI6ICJmaXJlYmFzZS1hZG1pbnNkay1mYnN2Y0B3b3JsZHdpc2UtZTIzOTkuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLA0KICAiY2xpZW50X2lkIjogIjEwNjY1NTExNDI0MjIyMjgyNjkyOSIsDQogICJhdXRoX3VyaSI6ICJodHRwczovL2FjY291bnRzLmdvb2dsZS5jb20vby9vYXV0aDIvYXV0aCIsDQogICJ0b2tlbl91cmkiOiAiaHR0cHM6Ly9vYXV0aDIuZ29vZ2xlYXBpcy5jb20vdG9rZW4iLA0KICAiYXV0aF9wcm92aWRlcl94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL29hdXRoMi92MS9jZXJ0cyIsDQogICJjbGllbnRfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9yb2JvdC92MS9tZXRhZGF0YS94NTA5L2ZpcmViYXNlLWFkbWluc2RrLWZic3ZjJTQwd29ybGR3aXNlLWUyMzk5LmlhbS5nc2VydmljZWFjY291bnQuY29tIiwNCiAgInVuaXZlcnNlX2RvbWFpbiI6ICJnb29nbGVhcGlzLmNvbSINCn0NCg==";

if (!serviceAccountBase64) {
  throw new Error('Missing FIREBASE_SERVICE_ACCOUNT environment variable');
}

const serviceAccount = JSON.parse(
  Buffer.from(serviceAccountBase64, 'base64').toString('utf-8')
);

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
  storageBucket: 'worldwise-e2399.firebasestorage.app',
});

const db = getFirestore();
const bucket = getStorage().bucket();

module.exports = { admin, db, bucket, FieldValue };
